<%= form_with model: purchase_order,
              class: "space-y-8",
              local: true,
              data: {
                controller: "purchase-order-form",
                purchase_order_form_products_url_value: "/providers/:provider_id/products"
              } do |f| %>

  <% if purchase_order.errors.any? %>
    <div class="alert-error">
      <h3 class="text-sm font-medium">Se encontraron errores:</h3>
      <div class="mt-2 text-sm">
        <ul role="list" class="list-disc space-y-1 pl-5">
          <% purchase_order.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="card">
    <h3 class="text-lg font-medium leading-6 text-foreground">Informacion General</h3>
    <p class="mt-1 text-sm text-muted-foreground">Datos principales de la orden de compra.</p>

    <div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
      <div class="sm:col-span-3">
        <%= f.label :code, "Nro. de Orden", class: "form-label" %>
        <%= f.text_field :code, class: "form-input",
            data: { purchase_order_form_target: "codeField" },
            placeholder: "Se generará automáticamente" %>
      </div>

      <div class="sm:col-span-3">
        <%= render "shared/async_combobox",
            name: "purchase_order[provider_id]",
            src: search_providers_path,
            value: purchase_order.provider_id,
            display: purchase_order.provider&.combobox_display,
            label: "Proveedor",
            placeholder: "Buscar proveedor...",
            hint: "Selecciona el proveedor",
            id: "provider_combobox",
            size: "full" %>
      </div>

      <div class="sm:col-span-3" data-purchase-order-form-target="destinationContainer">
        <%= render "shared/async_combobox",
            name: "purchase_order[destination_id]",
            src: ubigeos_path,
            value: purchase_order.destination_id,
            display: purchase_order.destination&.combobox_display,
            label: "Destino",
            optional: true,
            placeholder: "Buscar ubicacion...",
            hint: "Donde se entregara la mercaderia)",
            id: "destination_combobox",
            size: "full" %>
      </div>

      <% if purchase_order.sourceable.is_a?(Sale) || purchase_order.delivery_address.present? %>
        <div class="sm:col-span-6">
          <%= f.label :delivery_address, class: "form-label" do %>
            Direccion de Entrega <span class="text-muted-foreground font-normal">(dropshipping)</span>
          <% end %>
          <%= f.text_field :delivery_address, class: "form-input",
              placeholder: "Direccion donde se entregara la mercaderia al cliente" %>
        </div>
      <% end %>

      <div class="sm:col-span-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <%= f.label :issue_date, "Fecha de Emision", class: "form-label" %>
            <%= f.date_field :issue_date, class: "form-input", required: true %>
          </div>

          <div>
            <%= f.label :expected_date, class: "form-label" do %>
              Fecha de Despacho <span class="text-muted-foreground font-normal">(opcional)</span>
            <% end %>
            <%= f.date_field :expected_date, class: "form-input" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-medium leading-6 text-foreground">Items</h3>
        <p class="mt-1 text-sm text-muted-foreground">Productos a incluir en la orden.</p>
      </div>
    </div>

    <div id="items-container" data-purchase-order-form-target="itemsContainer">
      <div class="overflow-x-auto">
        <table class="min-w-[640px] w-full table-fixed divide-y divide-border">
          <colgroup>
            <col>
            <col class="w-[110px]">
            <col class="w-[140px]">
            <col class="w-[110px]">
            <col class="w-[48px]">
          </colgroup>
          <thead class="bg-muted/50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Producto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Cantidad</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Precio Unit.</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Total</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody data-purchase-order-form-target="itemsList" class="divide-y divide-border">
            <% if purchase_order.items.any? %>
              <% purchase_order.items.each_with_index do |item, index| %>
                <%= render "purchase_orders/item_fields", f: f, item: item, index: index %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 p-4 border-2 border-dashed border-border rounded-lg" data-purchase-order-form-target="addItemSection">
        <div class="flex items-end gap-4">
          <div class="flex-1">
            <label class="form-label">Agregar Producto</label>
            <div class="relative" data-purchase-order-form-target="productSearchContainer">
              <input type="text"
                     placeholder="Buscar producto del proveedor..."
                     class="form-input"
                     data-purchase-order-form-target="productSearch"
                     data-action="input->purchase-order-form#searchProducts focus->purchase-order-form#showProductDropdown"
                     autocomplete="off">
              <div class="absolute z-10 w-full mt-1 bg-card border border-border rounded-lg shadow-lg hidden max-h-60 overflow-y-auto"
                   data-purchase-order-form-target="productDropdown">
              </div>
            </div>
            <p class="mt-1 text-xs text-muted-foreground" data-purchase-order-form-target="productHint">
              Selecciona un proveedor primero
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Totals -->
    <div class="mt-6 border-t border-border pt-4">
      <div class="flex justify-end">
        <dl class="space-y-2 text-sm w-64">
          <div class="flex justify-between">
            <dt class="text-muted-foreground">Subtotal</dt>
            <dd class="font-medium text-foreground">S/ <span data-purchase-order-form-target="subtotal">0.00</span></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-muted-foreground">IGV (<%= (::PeruTax::IGV_RATE * 100).to_i %>%)</dt>
            <dd class="font-medium text-foreground">S/ <span data-purchase-order-form-target="tax">0.00</span></dd>
          </div>
          <div class="flex justify-between border-t border-border pt-2">
            <dt class="font-semibold text-foreground">Total</dt>
            <dd class="font-bold text-foreground text-lg">S/ <span data-purchase-order-form-target="total">0.00</span></dd>
          </div>
        </dl>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 class="text-lg font-medium leading-6 text-foreground">Notas</h3>
    <div class="mt-4">
      <%= f.text_area :notes,
                      class: "form-input min-h-[100px]",
                      placeholder: "Notas adicionales para esta orden..." %>
      <p class="hidden mt-2 text-sm text-amber-600"
         data-purchase-order-form-target="notesHint">
        Para una mejor ayuda, se han precargado las notas de la última orden de compra. Puedes editarlas libremente.
      </p>
    </div>
  </div>

  <!-- Template for new item row -->
  <template data-purchase-order-form-target="itemTemplate">
    <tr class="item-row" data-purchase-order-form-target="itemRow">
      <td class="px-4 py-3">
        <span class="product-name text-sm font-medium text-foreground"></span>
        <input type="hidden" name="purchase_order[items_attributes][NEW_INDEX][product_id]" class="product-id-input">
      </td>
      <td class="px-4 py-3">
        <input type="number"
               name="purchase_order[items_attributes][NEW_INDEX][quantity]"
               class="form-input w-full quantity-input"
               min="1"
               value="1"
               data-action="input->purchase-order-form#calculateRowTotal">
      </td>
      <td class="px-4 py-3">
        <input type="number"
               name="purchase_order[items_attributes][NEW_INDEX][unit_price]"
               class="form-input w-full unit-price-input"
               step="0.01"
               min="0"
               data-action="input->purchase-order-form#calculateRowTotal">
      </td>
      <td class="px-4 py-3">
        <span class="row-total text-sm font-medium text-foreground">S/ 0.00</span>
      </td>
      <td class="px-4 py-3">
        <button type="button"
                class="text-destructive hover:text-destructive/80"
                data-action="click->purchase-order-form#removeItem">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </td>
    </tr>
  </template>

  <div class="flex justify-end gap-3">
    <%= link_to "Cancelar", purchase_orders_path, class: "btn-secondary" %>
    <%= f.submit purchase_order.persisted? ? "Actualizar Orden" : "Crear Orden", class: "btn-primary cursor-pointer" %>
  </div>
<% end %>
