<div class="max-w-5xl mx-auto py-8 px-4">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold text-foreground"><%= @purchase_order.code %></h1>
        <span class="<%= @purchase_order.status_badge_class %>"><%= @purchase_order.status_label %></span>
      </div>
      <p class="mt-1 text-sm text-muted-foreground">
        Creada por <%= @purchase_order.created_by.first_name %> el <%= l(@purchase_order.created_at, format: :long) %>
      </p>
    </div>
    <div class="flex flex-wrap gap-3">
      <%= link_to "Volver", purchase_orders_path, class: "btn-secondary" %>
      <%= link_to "Descargar PDF", pdf_purchase_order_path(@purchase_order), class: "btn-secondary", data: { turbo: false } %>

      <% if @purchase_order.can_edit? && policy(@purchase_order).update? %>
        <%= link_to "Editar", edit_purchase_order_path(@purchase_order), class: "btn-secondary" %>
      <% end %>

      <% if @purchase_order.can_confirm? && policy(@purchase_order).confirm? %>
        <%= button_to "Confirmar", confirm_purchase_order_path(@purchase_order),
            method: :patch,
            class: "btn-primary",
            data: { turbo_confirm: "Confirmar esta orden? Una vez confirmada no podra editarse." } %>
      <% end %>

      <% if @purchase_order.can_receive? && policy(@purchase_order).receive? %>
        <%= button_to "Marcar Recibida", receive_purchase_order_path(@purchase_order),
            method: :patch,
            class: "btn-success",
            data: { turbo_confirm: "Marcar como recibida? Esto actualizara el stock de los productos." } %>
      <% end %>

      <% if @purchase_order.can_cancel? && policy(@purchase_order).cancel? %>
        <%= button_to "Cancelar", cancel_purchase_order_path(@purchase_order),
            method: :patch,
            class: "btn-destructive",
            data: { turbo_confirm: "Cancelar esta orden? Esta accion no se puede deshacer." } %>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="card">
      <h3 class="text-sm font-medium text-muted-foreground mb-2">Proveedor</h3>
      <p class="text-lg font-semibold text-foreground"><%= @purchase_order.provider.name %></p>
      <% if @purchase_order.provider.tax_id.present? %>
        <p class="text-sm text-muted-foreground">RUC: <%= @purchase_order.provider.tax_id %></p>
      <% end %>
    </div>

    <div class="card">
      <h3 class="text-sm font-medium text-muted-foreground mb-2">Fechas</h3>
      <p class="text-foreground">
        <span class="font-medium">Emision:</span> <%= l(@purchase_order.issue_date, format: :long) %>
      </p>
      <% if @purchase_order.expected_date.present? %>
        <p class="text-foreground">
          <span class="font-medium">Esperada:</span> <%= l(@purchase_order.expected_date, format: :long) %>
        </p>
      <% end %>
    </div>

    <div class="card">
      <h3 class="text-sm font-medium text-muted-foreground mb-2">Destino</h3>
      <p class="text-foreground"><%= @purchase_order.destination&.full_path || "No especificado" %></p>
    </div>
  </div>

  <% if @purchase_order.sourceable.is_a?(Sale) %>
    <div class="card mb-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <h3 class="text-sm font-medium text-muted-foreground mb-2">Origen</h3>
          <p class="text-foreground">
            Generada desde venta
            <%= link_to @purchase_order.sourceable.code, sale_path(@purchase_order.sourceable), class: "text-primary hover:underline font-medium" %>
          </p>
        </div>
        <div>
          <h3 class="text-sm font-medium text-muted-foreground mb-2">Cliente (Entrega)</h3>
          <p class="text-foreground font-medium"><%= @purchase_order.sourceable.customer.name %></p>
          <% if @purchase_order.delivery_address.present? %>
            <p class="text-sm text-muted-foreground"><%= @purchase_order.delivery_address %></p>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="card mb-8">
    <h3 class="text-lg font-medium text-foreground mb-4">Items</h3>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-border">
        <thead class="bg-muted/50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">NÂ°</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Producto</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Cantidad</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Precio Unit.</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <% @purchase_order.items.includes(:product).each_with_index do |item, index| %>
            <tr>
              <td class="px-4 py-3 text-sm text-muted-foreground"><%= index + 1 %></td>
              <td class="px-4 py-3">
                <p class="text-sm font-medium text-foreground"><%= item.product.name %></p>
                <% if item.product.sku.present? %>
                  <p class="text-xs text-muted-foreground">SKU: <%= item.product.sku %></p>
                <% end %>
              </td>
              <td class="px-4 py-3 text-sm text-foreground text-right">
                <%= item.quantity %> <%= item.unit_label %>
              </td>
              <td class="px-4 py-3 text-sm text-foreground text-right">
                S/ <%= number_with_precision(item.unit_price, precision: 2, delimiter: ",") %>
              </td>
              <td class="px-4 py-3 text-sm font-medium text-foreground text-right">
                S/ <%= number_with_precision(item.total, precision: 2, delimiter: ",") %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="mt-6 border-t border-border pt-4">
      <div class="flex justify-end">
        <dl class="space-y-2 text-sm w-64">
          <div class="flex justify-between">
            <dt class="text-muted-foreground">Subtotal</dt>
            <dd class="font-medium text-foreground">S/ <%= number_with_precision(@purchase_order.subtotal, precision: 2, delimiter: ",") %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-muted-foreground">IGV (<%= (PeruTax::IGV_RATE * 100).to_i %>%)</dt>
            <dd class="font-medium text-foreground">S/ <%= number_with_precision(@purchase_order.tax, precision: 2, delimiter: ",") %></dd>
          </div>
          <div class="flex justify-between border-t border-border pt-2">
            <dt class="font-semibold text-foreground">Total</dt>
            <dd class="font-bold text-foreground text-lg">S/ <%= number_with_precision(@purchase_order.total, precision: 2, delimiter: ",") %></dd>
          </div>
        </dl>
      </div>
    </div>
  </div>

  <% if @purchase_order.notes.present? %>
    <div class="card">
      <h3 class="text-lg font-medium text-foreground mb-2">Notas</h3>
      <p class="text-foreground whitespace-pre-wrap"><%= @purchase_order.notes %></p>
    </div>
  <% end %>
</div>
