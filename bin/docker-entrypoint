#!/bin/bash
set -e

# Ensure we can find the installed gems
export PATH="/usr/local/bundle/bin:$PATH"

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  # Remove any existing server.pid file to prevent "server already running" errors
  rm -f tmp/pids/server.pid
  
  # Prepare the database (create, migrate, seed)
  ./bin/rails db:prepare
  ./bin/rails db:prepare:cache
  ./bin/rails db:prepare:queue
  ./bin/rails db:prepare:cable
  ./bin/rails db:seed
fi

# Execute the command
exec "${@}"
