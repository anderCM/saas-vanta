# Dockerfile for local development
# This is simpler than the production Dockerfile and runs as root for convenience
FROM ruby:3.3.6-slim

# Install curl first (needed to download Node.js setup script)
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install Node.js 20 LTS
ARG NODE_VERSION=20
RUN curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - && \
    apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    nodejs \
    build-essential \
    git \
    libpq-dev \
    libvips \
    pkg-config && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Verify versions
RUN ruby --version && node --version && npm --version

# Set working directory
WORKDIR /rails

# Configure gem installation
ENV GEM_HOME="/usr/local/bundle"
ENV PATH="$GEM_HOME/bin:$PATH"

# Install Rails 8 (for initial project generation)
RUN gem install rails -v '~> 8.0'

# Verify rails is accessible
RUN which rails && rails --version

# Copy application code
COPY . .

# Install gems if Gemfile exists
RUN if [ -f Gemfile ]; then bundle install; fi

# Expose port 3000
EXPOSE 3000

# Use the entrypoint script to fix PATH and prepare DB
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start the server by default
CMD ["./bin/rails", "server", "-b", "0.0.0.0"]
